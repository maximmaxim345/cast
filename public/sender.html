<!DOCTYPE html>
<html>
<head>
  <title>Resonate over Cast Demo</title>
  <script src="https://www.gstatic.com/cv/js/sender/v1/cast_sender.js?loadCastFramework=1"></script>
  <style>
    * { box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      padding: 40px 20px;
      max-width: 500px;
      margin: 0 auto;
      background: #fafafa;
      color: #333;
      line-height: 1.6;
    }
    h1 {
      margin: 0 0 10px 0;
      font-size: 28px;
      font-weight: 600;
    }
    .description {
      color: #666;
      margin-bottom: 30px;
      font-size: 14px;
    }
    .disclaimer {
      background: #fff3cd;
      border: 1px solid #ffc107;
      border-radius: 8px;
      padding: 12px 16px;
      margin-bottom: 24px;
      font-size: 13px;
      color: #856404;
    }
    .card {
      background: white;
      border-radius: 12px;
      padding: 24px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      margin-bottom: 20px;
    }
    .server-config label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      font-size: 14px;
    }
    .server-config input {
      padding: 12px 14px;
      font-size: 16px;
      width: 100%;
      border: 1px solid #ddd;
      border-radius: 8px;
      transition: border-color 0.2s;
    }
    .server-config input:focus {
      outline: none;
      border-color: #4285f4;
    }
    .server-config small {
      color: #888;
      display: block;
      margin-top: 8px;
      font-size: 12px;
    }
    .buttons {
      display: flex;
      gap: 10px;
      margin-top: 20px;
      flex-wrap: wrap;
    }
    button {
      padding: 12px 24px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      border: none;
      border-radius: 8px;
      transition: all 0.2s;
    }
    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    #castBtn {
      background: #4285f4;
      color: white;
    }
    #castBtn:hover:not(:disabled) {
      background: #3367d6;
    }
    #stopBtn {
      background: #ea4335;
      color: white;
    }
    #stopBtn:hover:not(:disabled) {
      background: #c5221f;
    }
    #testBtn {
      background: #f1f3f4;
      color: #333;
    }
    #testBtn:hover:not(:disabled) {
      background: #e8eaed;
    }
    #status {
      margin-top: 20px;
      padding: 14px 16px;
      background: #f1f3f4;
      border-radius: 8px;
      font-size: 14px;
      color: #555;
    }
  </style>
</head>
<body>
  <h1>Resonate over Cast Demo</h1>
  <p class="description">
    A proof-of-concept implementation of the Resonate protocol inside a Chromecast receiver app.
    Since Resonate uses standard WebSockets, it can run on pretty much anything, including
    Google Cast and Cast Audio devices. This demo enables
    on-the-fly speaker grouping without Google Home setup, flexible device combinations
    beyond Google's restrictions (like pairing a Home Mini with a TV), and grouping with
    other Resonate-compatible speakers.
  </p>

  <div class="disclaimer">
    <strong>Note:</strong> This is experimental software. Audio glitches and crackling may still occur.
  </div>

  <div class="card">
    <div class="server-config">
      <label for="serverIp">Music Assistant Server IP</label>
      <input type="text" id="serverIp" placeholder="192.168.1.100">
      <small>Connects via WebSocket to ws://&lt;ip&gt;:8927/resonate</small>
    </div>

    <div class="buttons">
      <button id="castBtn" onclick="startCasting()" disabled>Cast to Device</button>
      <button id="stopBtn" onclick="stopCasting()" disabled>Stop</button>
      <button id="testBtn" onclick="testLocally()">Test in this Browser</button>
    </div>

    <div id="status">Loading Cast SDK...</div>
  </div>

  <script>
    const APP_ID = '938CBF87';
    const CAST_NAMESPACE = 'urn:x-cast:resonate';
    let castContext = null;
    let castSession = null;

    // Load saved IP from localStorage
    const savedIp = localStorage.getItem('resonate_server_ip');
    if (savedIp) {
      document.getElementById('serverIp').value = savedIp;
    }

    function getServerUrl() {
      const ip = document.getElementById('serverIp').value.trim();
      if (!ip) return null;
      localStorage.setItem('resonate_server_ip', ip);
      return `http://${ip}:8927`;
    }

    function testLocally() {
      const serverUrl = getServerUrl();
      if (!serverUrl) {
        document.getElementById('status').textContent = 'Please enter server IP first';
        return;
      }
      // Open receiver in new tab with server URL as query param
      window.open('../index.html?server=' + encodeURIComponent(serverUrl), '_blank');
    }

    window['__onGCastApiAvailable'] = function(isAvailable) {
      if (isAvailable) {
        initializeCast();
      } else {
        document.getElementById('status').textContent = 'Cast SDK not available. Use Chrome browser or test locally.';
      }
    };

    function initializeCast() {
      try {
        castContext = cast.framework.CastContext.getInstance();
        castContext.setOptions({
          receiverApplicationId: APP_ID,
          autoJoinPolicy: chrome.cast.AutoJoinPolicy.ORIGIN_SCOPED
        });

        castContext.addEventListener(
          cast.framework.CastContextEventType.SESSION_STATE_CHANGED,
          (event) => {
            const state = event.sessionState;

            if (state === cast.framework.SessionState.SESSION_STARTED) {
              castSession = castContext.getCurrentSession();
              document.getElementById('stopBtn').disabled = false;
              document.getElementById('castBtn').disabled = true;

              // Send server URL to receiver
              const serverUrl = getServerUrl();
              const ip = document.getElementById('serverIp').value.trim();
              if (serverUrl) {
                castSession.sendMessage(CAST_NAMESPACE, { serverUrl })
                  .then(() => {
                    document.getElementById('status').textContent = 'Connected! Connecting to ws://' + ip + ':8927/resonate';
                  })
                  .catch((err) => {
                    document.getElementById('status').textContent = 'Connected but failed to send config: ' + err;
                  });
              } else {
                document.getElementById('status').textContent = 'Connected but no server IP configured!';
              }
            } else if (state === cast.framework.SessionState.SESSION_ENDED) {
              castSession = null;
              document.getElementById('stopBtn').disabled = true;
              document.getElementById('castBtn').disabled = false;
              document.getElementById('status').textContent = 'Ready to cast';
            }
          }
        );

        document.getElementById('castBtn').disabled = false;
        document.getElementById('status').textContent = 'Ready to cast';
      } catch (e) {
        document.getElementById('status').textContent = 'Error: ' + e.message;
      }
    }

    function startCasting() {
      if (!castContext) return;

      const serverUrl = getServerUrl();
      if (!serverUrl) {
        document.getElementById('status').textContent = 'Please enter server IP first';
        return;
      }

      castContext.requestSession().catch((error) => {
        document.getElementById('status').textContent = 'Cast error: ' + error;
      });
    }

    function stopCasting() {
      if (castSession) {
        castSession.endSession(true);
      }
    }
  </script>
</body>
</html>
